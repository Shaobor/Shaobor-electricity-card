import { LitElement, html, css } from '\u0068\u0074\u0074\u0070\u0073\u003A\u002F\u002F\u0063\u0064\u006E\u002E\u006A\u0073\u0064\u0065\u006C\u0069\u0076\u0072\u002E\u006E\u0065\u0074\u002F\u0067\u0068\u002F\u006C\u0069\u0074\u002F\u0064\u0069\u0073\u0074\u0040\u0032\u002F\u0063\u006F\u0072\u0065\u002F\u006C\u0069\u0074\u002D\u0063\u006F\u0072\u0065\u002E\u006D\u0069\u006E\u002E\u006A\u0073'; class SgccElectricityCardEditor extends LitElement { static get properties() { return { '\u0068\u0061\u0073\u0073': { type: Object }, '\u0063\u006F\u006E\u0066\u0069\u0067': { type: Object }, }; } constructor() { super(); this['\u0063\u006F\u006E\u0066\u0069\u0067'] = {}; this._hass = null; this._schema = [ { name: '\u0074\u0069\u0074\u006C\u0065', label: 'Ê†áÈ¢ò (ÂèØÈÄâ)', selector: { text: {} }, }, { name: '\u0065\u006E\u0074\u0069\u0074\u0079', label: 'ÁîµË¥π‰ø°ÊÅØÂÆû‰Ωì (‰ΩôÈ¢ù/Êú¨Êúà/Êó•Áî®)', selector: { '\u0065\u006E\u0074\u0069\u0074\u0079': { domain: 'sensor' } }, }, { name: '\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079', label: 'ÁîµÈáè‰ø°ÊÅØÂÆû‰Ωì (Âπ¥Â∫¶Èò∂Ê¢Ø)', selector: { '\u0065\u006E\u0074\u0069\u0074\u0079': { domain: 'sensor' } }, }, { name: '\u0064\u0061\u0069\u006C\u0079\u005F\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079', label: 'Êó•Áî®ÁîµÂÆû‰Ωì', selector: { '\u0065\u006E\u0074\u0069\u0074\u0079': { domain: 'sensor' } }, }, { name: '\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u005F\u0065\u006E\u0074\u0069\u0074\u0079', label: 'Áº¥Ë¥πËÆ∞ÂΩïÂÆû‰Ωì (ÂèØÈÄâ)', selector: { '\u0065\u006E\u0074\u0069\u0074\u0079': { domain: 'sensor' } }, }, { name: '\u0065\u006E\u0061\u0062\u006C\u0065\u005F\u0064\u0061\u0069\u006C\u0079\u005F\u0063\u0061\u006C\u0065\u006E\u0064\u0061\u0072', label: 'ÂºÄÂêØÁî®ÁîµÊó•ÂéÜÂäüËÉΩ', selector: { boolean: {} }, }, ]; } setConfig(config) { this['\u0063\u006F\u006E\u0066\u0069\u0067'] = config ? { ..['\u0063\u006F\u006E\u0066\u0069\u0067'] } : {}; this['\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u0055\u0070\u0064\u0061\u0074\u0065'](); } _handleFormValueChanged(ev) { ev.stopPropagation(); const value = ev.detail.value; if (!value) { return; } if (this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0065\u006E\u0074\u0069\u0074\u0079'] === value['\u0065\u006E\u0074\u0069\u0074\u0079'] && this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079'] === value['\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079'] && this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079'] === value['\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079'] && this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0064\u0061\u0069\u006C\u0079\u005F\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079'] === value['\u0064\u0061\u0069\u006C\u0079\u005F\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079'] && this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u005F\u0065\u006E\u0074\u0069\u0074\u0079'] === value['\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u005F\u0065\u006E\u0074\u0069\u0074\u0079'] && this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0074\u0069\u0074\u006C\u0065'] === value['\u0074\u0069\u0074\u006C\u0065'] && this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0065\u006E\u0061\u0062\u006C\u0065\u005F\u0064\u0061\u0069\u006C\u0079\u005F\u0063\u0061\u006C\u0065\u006E\u0064\u0061\u0072'] === value['\u0065\u006E\u0061\u0062\u006C\u0065\u005F\u0064\u0061\u0069\u006C\u0079\u005F\u0063\u0061\u006C\u0065\u006E\u0064\u0061\u0072']) { return; } this['\u0063\u006F\u006E\u0066\u0069\u0067'] = value; const event = new Event('config-changed', { bubbles: true, composed: true, }); event.detail = { '\u0063\u006F\u006E\u0066\u0069\u0067': value }; this.dispatchEvent(event); } _computeLabel(schema) { return schema.label || schema.name; } render() { if (!this['\u0068\u0061\u0073\u0073']) { return html``; } return html` <div class="card-config"> <ha-form ['\u0068\u0061\u0073\u0073']=${this['\u0068\u0061\u0073\u0073']} .data=${this['\u0063\u006F\u006E\u0066\u0069\u0067']} .schema=${this._schema} .computeLabel=${this._computeLabel} @value-changed=${this._handleFormValueChanged} ></ha-form> </div> `; } static get styles() { return css` .card-config { padding: 16px; } `; } } customElements.define('sgcc-electricity-card-editor', SgccElectricityCardEditor); class SgccElectricityCard extends LitElement { static get properties() { return { '\u0068\u0061\u0073\u0073': { type: Object }, '\u0063\u006F\u006E\u0066\u0069\u0067': { type: Object }, '\u005F\u0073\u0068\u006F\u0077\u0048\u0069\u0073\u0074\u006F\u0072\u0079': { type: Boolean }, '\u005F\u0073\u0068\u006F\u0077\u0050\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079': { type: Boolean }, }; } constructor() { super(); this['\u005F\u0073\u0068\u006F\u0077\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] = false; this['\u005F\u0073\u0068\u006F\u0077\u0050\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] = false; } static getConfigElement() { return document.createElement('sgcc-electricity-card-editor'); } static getStubConfig() { return { '\u0065\u006E\u0074\u0069\u0074\u0079': 'sensor.sgcc_balance', }; } setConfig(config) { if (!config['\u0065\u006E\u0074\u0069\u0074\u0079']) { throw new Error('ËØ∑ÂÆö‰πâ entity'); } this['\u0063\u006F\u006E\u0066\u0069\u0067'] = config; this._enableCalendar = config['\u0065\u006E\u0061\u0062\u006C\u0065\u005F\u0064\u0061\u0069\u006C\u0079\u005F\u0063\u0061\u006C\u0065\u006E\u0064\u0061\u0072'] !== false; this['\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u0055\u0070\u0064\u0061\u0074\u0065'](); } getCardSize() { return 6; } _toggleHistory(e) { if (e) e.stopPropagation(); this['\u005F\u0073\u0068\u006F\u0077\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] = !this['\u005F\u0073\u0068\u006F\u0077\u0048\u0069\u0073\u0074\u006F\u0072\u0079']; if (!this['\u005F\u0073\u0068\u006F\u0077\u0048\u0069\u0073\u0074\u006F\u0072\u0079']) { this['\u005F\u0073\u0065\u006C\u0065\u0063\u0074\u0065\u0064\u0044\u0061\u0079'] = null; } this['\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u0055\u0070\u0064\u0061\u0074\u0065'](); } _togglePayHistory(e) { if (e) e.stopPropagation(); this['\u005F\u0073\u0068\u006F\u0077\u0050\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] = !this['\u005F\u0073\u0068\u006F\u0077\u0050\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079']; this['\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u0055\u0070\u0064\u0061\u0074\u0065'](); } _showDayDetail(e, data, dateKey) { if (e) e.stopPropagation(); console.log('SGCC Card: Selected Day Data:', data); this['\u005F\u0073\u0065\u006C\u0065\u0063\u0074\u0065\u0064\u0044\u0061\u0079'] = { data, dateKey }; this['\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u0055\u0070\u0064\u0061\u0074\u0065'](); } _closeDayDetail(e) { if (e) e.stopPropagation(); this['\u005F\u0073\u0065\u006C\u0065\u0063\u0074\u0065\u0064\u0044\u0061\u0079'] = null; this['\u0072\u0065\u0071\u0075\u0065\u0073\u0074\u0055\u0070\u0064\u0061\u0074\u0065'](); } render() { if (!this['\u0068\u0061\u0073\u0073'] || !this['\u0063\u006F\u006E\u0066\u0069\u0067']) { return html``; } const mainEntity = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073'][this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0065\u006E\u0074\u0069\u0074\u0079']]; if (!mainEntity) { return html` <ha-card style="padding: 16px; color: white; background: #ef4444;"> Êâæ‰∏çÂà∞ÂÆû‰Ωì: ${this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0065\u006E\u0074\u0069\u0074\u0079']} </ha-card> `; } const attrs = mainEntity['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073'] || {}; let balance = 0; let monthlyUsage = 0; let monthlyCost = 0; let currentPrice = 0; let tierLevel = 'Êú™Áü•'; let paymentDeadline = ''; let updateTime = ''; let lastMonthCost = 0; if (attrs.estiAmt || attrs.esti_amt || attrs.estiamt) { lastMonthCost = parseFloat(attrs.estiAmt || attrs.esti_amt || attrs.estiamt); } let totalYearPq = 0; let totalYearCost = 0; let yearlyUsage = 0; if (this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079']) { const usageState = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073'][this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079']]; if (usageState) { const uAttrs = usageState['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']; let yearlyUsageFromState = parseFloat(usageState['\u0073\u0074\u0061\u0074\u0065']); if (!isNaN(yearlyUsageFromState)) yearlyUsage = yearlyUsageFromState; if (uAttrs['\u0074\u006F\u0074\u0061\u006C\u0065\u006C\u0065\u006E\u0075\u006D'] !== undefined) totalYearPq = parseFloat(uAttrs['\u0074\u006F\u0074\u0061\u006C\u0065\u006C\u0065\u006E\u0075\u006D']); if (uAttrs['\u0074\u006F\u0074\u0061\u006C\u0065\u006C\u0065\u0063\u006F\u0073\u0074'] !== undefined) totalYearCost = parseFloat(uAttrs['\u0074\u006F\u0074\u0061\u006C\u0065\u006C\u0065\u0063\u006F\u0073\u0074']); if (uAttrs['\u0074\u0069\u0065\u0072\u005F\u006C\u0065\u0076\u0065\u006C'] || uAttrs['\u0074\u0069\u0065\u0072\u004C\u0065\u0076\u0065\u006C']) { tierLevel = uAttrs['\u0074\u0069\u0065\u0072\u005F\u006C\u0065\u0076\u0065\u006C'] || uAttrs['\u0074\u0069\u0065\u0072\u004C\u0065\u0076\u0065\u006C']; } const list = uAttrs['\u006D\u006F\u0074\u0068\u0065\u006C\u0065\u006C\u0069\u0073\u0074'] || uAttrs['\u006D\u006F\u006E\u0074\u0068\u0045\u006C\u0065\u004C\u0069\u0073\u0074'] || []; if (Array.isArray(list) && list.length > 0) { const now = new Date(); let year = now.getFullYear(); let month = now.getMonth(); if (month === 0) { month = 12; year -= 1; } const targetStr = `${year}${month.toString().padStart(2, '0')}`; const match = list.find(item => item.month == targetStr); if (match) { monthlyUsage = parseFloat(match['\u006D\u006F\u006E\u0074\u0068\u0045\u006C\u0065\u004E\u0075\u006D'] || 0); lastMonthCost = parseFloat(match['\u006D\u006F\u006E\u0074\u0068\u0045\u006C\u0065\u0043\u006F\u0073\u0074'] || 0); } } } } else { totalYearPq = parseFloat(attrs.yearly_usage || attrs.yearlyUsage || attrs.totalEleNum) || 0; totalYearCost = parseFloat(attrs.totalEleCost || attrs.total_ele_cost) || 0; } if (yearlyUsage === 0 && totalYearPq > 0) { yearlyUsage = totalYearPq; } if (attrs['\u0070\u0072\u0065\u0070\u0061\u0079\u0062\u0061\u006C'] !== undefined || attrs['\u0070\u0072\u0065\u0070\u0061\u0079\u0042\u0061\u006C'] !== undefined) { balance = parseFloat(attrs['\u0073\u0075\u006D\u006D\u006F\u006E\u0065\u0079'] || attrs['\u0073\u0075\u006D\u004D\u006F\u006E\u0065\u0079'] || mainEntity['\u0073\u0074\u0061\u0074\u0065']) || 0; if (monthlyUsage === 0) { monthlyUsage = parseFloat(attrs['\u0074\u006F\u0074\u0061\u006C\u0070\u0071'] || attrs['\u0074\u006F\u0074\u0061\u006C\u0050\u0071']) || 0; } monthlyCost = parseFloat(attrs['\u0070\u0072\u0065\u0070\u0061\u0079\u0062\u0061\u006C'] || attrs['\u0070\u0072\u0065\u0070\u0061\u0079\u0042\u0061\u006C']) || 0; updateTime = attrs['\u0061\u006D\u0074\u0074\u0069\u006D\u0065'] || attrs['\u0061\u006D\u0074\u0054\u0069\u006D\u0065'] || ''; currentPrice = parseFloat(attrs['\u0063\u0075\u0072\u0072\u0065\u006E\u0074\u005F\u0070\u0072\u0069\u0063\u0065'] || attrs['\u0063\u0075\u0072\u0072\u0065\u006E\u0074\u0050\u0072\u0069\u0063\u0065']) || 0; if (tierLevel === 'Êú™Áü•' && (attrs['\u0074\u0069\u0065\u0072\u005F\u006C\u0065\u0076\u0065\u006C'] || attrs['\u0074\u0069\u0065\u0072\u004C\u0065\u0076\u0065\u006C'])) { tierLevel = attrs['\u0074\u0069\u0065\u0072\u005F\u006C\u0065\u0076\u0065\u006C'] || attrs['\u0074\u0069\u0065\u0072\u004C\u0065\u0076\u0065\u006C']; } if (tierLevel === 'Êú™Áü•' && yearlyUsage > 0) { if (yearlyUsage > 3600) { tierLevel = '‰∏âÊ°£'; } else if (yearlyUsage > 2400) { tierLevel = '‰∫åÊ°£'; } else { tierLevel = '‰∏ÄÊ°£'; } } if (currentPrice === 0) { const basePrice = 0.51; if (tierLevel.includes('‰∏âÊ°£')) { currentPrice = basePrice + 0.3; } else if (tierLevel.includes('‰∫åÊ°£')) { currentPrice = basePrice + 0.05; } else { currentPrice = basePrice; } } paymentDeadline = attrs['\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u005F\u0064\u0065\u0061\u0064\u006C\u0069\u006E\u0065'] || attrs['\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u0044\u0065\u0061\u0064\u006C\u0069\u006E\u0065'] || ''; } else { const usageEntity = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073']['sensor.sgcc_monthly_usage']; const costEntity = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073']['sensor.sgcc_monthly_cost']; const priceEntity = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073']['sensor.sgcc_current_price']; const tierEntity = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073']['sensor.sgcc_tier_level']; const yearlyEntity = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073']['sensor.sgcc_yearly_usage']; const deadlineEntity = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073']['sensor.sgcc_payment_deadline']; balance = parseFloat(mainEntity['\u0073\u0074\u0061\u0074\u0065']) || 0; monthlyUsage = parseFloat(usageEntity?['\u0073\u0074\u0061\u0074\u0065']) || 0; monthlyCost = parseFloat(costEntity?['\u0073\u0074\u0061\u0074\u0065']) || 0; currentPrice = parseFloat(priceEntity?['\u0073\u0074\u0061\u0074\u0065']) || 0; tierLevel = tierEntity?['\u0073\u0074\u0061\u0074\u0065'] || 'Êú™Áü•'; yearlyUsage = parseFloat(yearlyEntity?['\u0073\u0074\u0061\u0074\u0065']) || 0; paymentDeadline = deadlineEntity?['\u0073\u0074\u0061\u0074\u0065'] || ''; } const tier1Max = 2040; const tier2Max = 3120; if (tierLevel === 'Êú™Áü•' && yearlyUsage > 0) { if (yearlyUsage > tier2Max) { tierLevel = '‰∏âÊ°£'; } else if (yearlyUsage > tier1Max) { tierLevel = '‰∫åÊ°£'; } else { tierLevel = '‰∏ÄÊ°£'; } } const tier1Usage = Math.min(yearlyUsage, tier1Max); const tier2Usage = Math.min(Math.max(yearlyUsage - tier1Max, 0), tier2Max - tier1Max); const tier3Usage = Math.max(yearlyUsage - tier2Max, 0); const tier1Percent = (tier1Usage / tier1Max) * 100; const tier2Percent = (tier2Usage / (tier2Max - tier1Max)) * 100; const tier3Percent = tier3Usage > 0 ? 50 : 0; let deadlineText = paymentDeadline; if (paymentDeadline) { const deadline = new Date(paymentDeadline); const now = new Date(); const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24)); if (daysLeft >= 0) { deadlineText = `${paymentDeadline} (${daysLeft}Â§©Âêé)`; } } let dailyUsage = '0'; let rawDailyList = []; const dailyEntityId = this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0064\u0061\u0069\u006C\u0079\u005F\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079']; const isValidUsage = (val) => { return val !== undefined && val !== null && val !== '' && val !== '-' && !isNaN(parseFloat(val)); }; const getUsageFromList = (attributes) => { const list = attributes['\u0073\u0065\u0076\u0065\u006E\u0065\u006C\u0065\u006C\u0069\u0073\u0074'] || attributes['\u0073\u0065\u0076\u0065\u006E\u0045\u006C\u0065\u004C\u0069\u0073\u0074'] || attributes['\u0073\u0065\u0076\u0065\u006E\u005F\u0065\u006C\u0065\u005F\u006C\u0069\u0073\u0074'] || []; if (Array.isArray(list) && list.length > 0) { return { list }; } return null; }; if (dailyEntityId && this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073'][dailyEntityId]) { const dailyState = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073'][dailyEntityId]; const dAttrs = dailyState['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']; const listResult = getUsageFromList(dAttrs); if (listResult) { rawDailyList = listResult.list; for (const item of rawDailyList) { if (isValidUsage(item['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071'])) { dailyUsage = item['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071']; break; } } } else if (isValidUsage(dailyState['\u0073\u0074\u0061\u0074\u0065'])) { dailyUsage = dailyState['\u0073\u0074\u0061\u0074\u0065']; } else { dailyUsage = dAttrs['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071'] || dAttrs['\u0064\u0061\u0069\u006C\u0079\u005F\u0075\u0073\u0061\u0067\u0065'] || dAttrs['\u0064\u0061\u0069\u006C\u0079\u0055\u0073\u0061\u0067\u0065'] || '0'; } } else { const listResult = getUsageFromList(attrs); if (listResult) { rawDailyList = listResult.list; for (const item of rawDailyList) { if (isValidUsage(item['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071'])) { dailyUsage = item['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071']; break; } } } else { dailyUsage = attrs['\u0064\u0061\u0069\u006C\u0079\u005F\u0075\u0073\u0061\u0067\u0065'] || attrs['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071'] || attrs['\u0064\u0061\u0069\u006C\u0079\u0055\u0073\u0061\u0067\u0065'] || '0'; } } let estimatedDaysText = ''; const dailyUsageNum = parseFloat(dailyUsage); if (balance > 0 && dailyUsageNum > 0 && currentPrice > 0) { const dailyCost = dailyUsageNum * currentPrice; const days = Math.floor(balance / dailyCost); if (days < 999) { estimatedDaysText = `È¢ÑËÆ°ÂèØÁî® ${days} Â§©`; } } const getPayList = (a) => { if (!a) return []; return a['\u0070\u0061\u0079\u006C\u0069\u0073\u0074'] || a['\u0070\u0061\u0079\u005F\u0068\u0069\u0073\u0074\u006F\u0072\u0079'] || a['\u0070\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] || a['\u0070\u0061\u0079\u005F\u006C\u0069\u0073\u0074'] || a['\u0070\u0061\u0079\u004C\u0069\u0073\u0074'] || a['\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u005F\u006C\u0069\u0073\u0074'] || a['\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] || []; }; let payList = []; if (this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u005F\u0065\u006E\u0074\u0069\u0074\u0079']) { const payState = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073'][this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0070\u0061\u0079\u006D\u0065\u006E\u0074\u005F\u0065\u006E\u0074\u0069\u0074\u0079']]; if (payState) { console.log('SGCC Card (Debug): Payment Entity Attributes:', payState['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']); payList = getPayList(payState['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']); console.log('SGCC Card (Debug): Extracted PayList:', payList); } } if ((!payList || payList.length === 0) && this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079']) { const uState = this['\u0068\u0061\u0073\u0073']['\u0073\u0074\u0061\u0074\u0065\u0073'][this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0075\u0073\u0061\u0067\u0065\u005F\u0065\u006E\u0074\u0069\u0074\u0079']]; if (uState) { const list = getPayList(uState['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']); if (list && list.length > 0) payList = list; } } if (!payList || payList.length === 0) { const list = getPayList(attrs); if (list && list.length > 0) payList = list; } let payHistoryHtml = html``; if (Array.isArray(payList) && payList.length > 0) { const sorted = [..['\u0070\u0061\u0079\u004C\u0069\u0073\u0074']].sort((a, b) => { const da = new Date(a['\u0070\u0061\u0079\u0044\u0061\u0074\u0065'] || a['\u0079\u006D\u0064'] || a['\u0070\u0061\u0079\u005F\u0064\u0061\u0074\u0065'] || a['\u0064\u0061\u0074\u0065'] || 0); const db = new Date(b['\u0070\u0061\u0079\u0044\u0061\u0074\u0065'] || b['\u0079\u006D\u0064'] || b['\u0070\u0061\u0079\u005F\u0064\u0061\u0074\u0065'] || b['\u0064\u0061\u0074\u0065'] || 0); return db - da; }).slice(0, 3); const itemsHtml = sorted.map(item => { const date = item['\u0070\u0061\u0079\u0044\u0061\u0074\u0065'] || item['\u0079\u006D\u0064'] || item['\u0070\u0061\u0079\u005F\u0064\u0061\u0074\u0065'] || item['\u0064\u0061\u0074\u0065'] || 'Êú™Áü•Êó•Êúü'; const dateStr = date.length > 10 ? date.substring(0, 10) : date; const amt = item['\u0072\u0063\u0076\u0041\u006D\u0074'] || item['\u0070\u0061\u0079\u0041\u006D\u0074'] || item['\u0070\u0061\u0079\u005F\u0061\u006D\u0074'] || item['\u006D\u006F\u006E\u0065\u0079'] || item['\u0061\u006D\u0074'] || 0; return html` <div class="pay-item"> <div class="pay-date">${dateStr}</div> <div class="pay-amt">+ ${parseFloat(amt).toFixed(2)} ÂÖÉ</div> </div> `; }); payHistoryHtml = html` <div class="pay-section" @click=${this['\u005F\u0074\u006F\u0067\u0067\u006C\u0065\u0050\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079']} style="cursor: pointer;"> <div class="pay-title" style="color: white; font-weight: bold; opacity: 1;"> <ha-icon icon="mdi:history" style="--mdc-icon-size: 16px; margin-right: 4px;"></ha-icon> ÊúÄËøëÁº¥Ë¥π </div> <div class="pay-list"> ${itemsHtml} </div> </div> `; } let fullPayHistoryHtml = html``; if (this['\u005F\u0073\u0068\u006F\u0077\u0050\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] && payList.length > 0) { const fullSorted = [..['\u0070\u0061\u0079\u004C\u0069\u0073\u0074']].sort((a, b) => { const da = new Date(a['\u0070\u0061\u0079\u0044\u0061\u0074\u0065'] || a['\u0079\u006D\u0064'] || a['\u0070\u0061\u0079\u005F\u0064\u0061\u0074\u0065'] || a['\u0064\u0061\u0074\u0065'] || 0); const db = new Date(b['\u0070\u0061\u0079\u0044\u0061\u0074\u0065'] || b['\u0079\u006D\u0064'] || b['\u0070\u0061\u0079\u005F\u0064\u0061\u0074\u0065'] || b['\u0064\u0061\u0074\u0065'] || 0); return db - da; }); let totalAmt = 0; const channelStats = {}; fullSorted.forEach(item => { const amt = parseFloat(item['\u0072\u0063\u0076\u0041\u006D\u0074'] || item['\u0070\u0061\u0079\u0041\u006D\u0074'] || item['\u0070\u0061\u0079\u005F\u0061\u006D\u0074'] || item['\u006D\u006F\u006E\u0065\u0079'] || item['\u0061\u006D\u0074'] || 0); const channel = item['\u0063\u0068\u0061\u006E\u0043\u006C\u0073'] || item['\u0063\u0068\u0061\u006E\u004E\u0061\u006D\u0065'] || item['\u0070\u0061\u0079\u004D\u006F\u0064\u0065\u004E\u0061\u006D\u0065'] || 'ÂÖ∂‰ªñÊ∏†ÈÅì'; totalAmt += amt; if (!channelStats[channel]) channelStats[channel] = 0; channelStats[channel] += amt; }); const fullItemsHtml = fullSorted.map(item => { const date = item['\u0070\u0061\u0079\u0044\u0061\u0074\u0065'] || item['\u0079\u006D\u0064'] || item['\u0070\u0061\u0079\u005F\u0064\u0061\u0074\u0065'] || item['\u0064\u0061\u0074\u0065'] || 'Êú™Áü•Êó•Êúü'; const dateStr = date.length > 10 ? date.substring(0, 10) : date; const amt = item['\u0072\u0063\u0076\u0041\u006D\u0074'] || item['\u0070\u0061\u0079\u0041\u006D\u0074'] || item['\u0070\u0061\u0079\u005F\u0061\u006D\u0074'] || item['\u006D\u006F\u006E\u0065\u0079'] || item['\u0061\u006D\u0074'] || 0; const channel = item['\u0063\u0068\u0061\u006E\u0043\u006C\u0073'] || item['\u0063\u0068\u0061\u006E\u004E\u0061\u006D\u0065'] || item['\u0070\u0061\u0079\u004D\u006F\u0064\u0065\u004E\u0061\u006D\u0065'] || ''; return html` <div class="pay-item" style="padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: flex-start;"> <div style="display: flex; flex-direction: column;"> <div class="pay-date" style="font-size: 14px; opacity: 0.9;">${dateStr}</div> ${channel ? html`<div class="pay-channel" style="font-size: 12px; opacity: 0.5; margin-top: 2px;">${channel}</div>` : ''} </div> <div class="pay-amt" style="font-size: 15px; font-weight: bold;">+ ${parseFloat(amt).toFixed(2)} ÂÖÉ</div> </div> `; }); const statsHtml = html` <div class="pay-stats" style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-bottom: 0; font-size: 13px;"> <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 6px;"> <span>Áº¥Ë¥πÊÄªËÆ°</span> <span>${totalAmt.toFixed(2)} ÂÖÉ</span> </div> ${Object.keys(channelStats).map(chan => html` <div style="display: flex; justify-content: space-between; opacity: 0.8; margin-bottom: 4px;"> <span>${chan}</span> <span>${channelStats[chan].toFixed(2)} ÂÖÉ</span> </div> `)} </div> `; fullPayHistoryHtml = html` <div class="modal-overlay" @click=${this['\u005F\u0074\u006F\u0067\u0067\u006C\u0065\u0050\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079']}> <div class="modal-content" style="max-height: 60vh; max-width: 90%; width: 360px; display: flex; flex-direction: column;" @click=${e => e.stopPropagation()}> <div class="modal-header"> <h3>Áº¥Ë¥πËÆ∞ÂΩï (${fullSorted.length}Êù°)</h3> <ha-icon icon="mdi:close" @click=${this['\u005F\u0074\u006F\u0067\u0067\u006C\u0065\u0050\u0061\u0079\u0048\u0069\u0073\u0074\u006F\u0072\u0079']} style="cursor: pointer;"></ha-icon> </div> <div style="padding: 16px 16px 8px 16px; flex-shrink: 0;"> ${statsHtml} </div> <div class="pay-full-list" style="padding: 0 16px 16px 16px; overflow-y: auto; flex: 1;"> ${fullItemsHtml} </div> </div> </div> `; } let historyHtml = html``; if (this['\u005F\u0073\u0068\u006F\u0077\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] && rawDailyList.length > 0) { let targetYear = new Date().getFullYear(); let targetMonth = new Date().getMonth(); let maxDateInt = 0; const dataMap = new Map(); rawDailyList.forEach(item => { if (item.day) { const dInt = parseInt(item.day); if (dInt > maxDateInt) { maxDateInt = dInt; } if (isValidUsage(item['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071'])) { const usage = parseFloat(item['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071']); const cost = (usage * currentPrice).toFixed(2); dataMap.set(item.day, { usage, cost, item }); } } }); if (maxDateInt > 0) { const s = maxDateInt.toString(); targetYear = parseInt(s.substr(0, 4)); targetMonth = parseInt(s.substr(4, 2)) - 1; } const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate(); const firstDayObj = new Date(targetYear, targetMonth, 1); const firstDayWeek = firstDayObj.getDay() === 0 ? 7 : firstDayObj.getDay(); const emptyCells = []; for (let i = 1; i < firstDayWeek; i++) { emptyCells.push(html`<div class="calendar-cell empty"></div>`); } const dayCells = []; for (let d = 1; d <= daysInMonth; d++) { const mStr = (targetMonth + 1).toString().padStart(2, '0'); const dStr = d.toString().padStart(2, '0'); const dateKey = `${targetYear}${mStr}${dStr}`; const dayData = dataMap.get(dateKey); const hasUsage = dayData !== undefined; let usage = hasUsage ? dayData.usage : 0; let usageStr = hasUsage ? usage.toFixed(2) : '-'; let costStr = hasUsage ? dayData.cost : ''; if (hasUsage) { } let colorClass = ''; if (hasUsage) { if (usage > 20) colorClass = 'high'; else if (usage > 10) colorClass = 'medium'; else colorClass = 'low'; } const contentHtml = hasUsage ? html` <div class="cell-usage">${usageStr}<span class="unit">¬∞</span></div> <div class="cell-cost">${costStr}</div> ` : html` <div class="cell-usage" style="opacity: 0.5">-</div> `; dayCells.push(html` <div class="calendar-cell ${hasUsage ? 'has-data' : 'no-data'} ${colorClass}" @click=${(e) => hasUsage ? this['\u005F\u0073\u0068\u006F\u0077\u0044\u0061\u0079\u0044\u0065\u0074\u0061\u0069\u006C'](e, dayData, dateKey) : null}> <div class="cell-date">${d}</div> <div class="cell-content"> ${contentHtml} </div> </div> `); } let monthTotalUsage = 0; let monthTotalCost = 0; dataMap.forEach((val, key) => { monthTotalUsage += val.usage; monthTotalCost += parseFloat(val.cost); }); let detailPopupHtml = html``; if (this['\u005F\u0073\u0065\u006C\u0065\u0063\u0074\u0065\u0064\u0044\u0061\u0079']) { const d = this['\u005F\u0073\u0065\u006C\u0065\u0063\u0074\u0065\u0064\u0044\u0061\u0079']; const item = d.data.item; const valT = parseFloat(item.thisTPq || item.spikeElePq || item.ele_s_pq || item.daySpikeElePq || item.sPq || 0); const valP = parseFloat(item.thisPPq || item.peakElePq || item.ele_p_pq || item.dayPeakElePq || item.pPq || 0); const valN = parseFloat(item.thisNPq || item.flatElePq || item.ele_n_pq || item.dayFlatElePq || item.nPq || item.fPq || 0); const valV = parseFloat(item.thisVPq || item.valleyElePq || item.ele_v_pq || item.dayValleyElePq || item.vPq || item.gPq || 0); const totalVal = parseFloat(item['\u0064\u0061\u0079\u0045\u006C\u0065\u0050\u0071'] || (valT + valP + valN + valV) || 0); let safeTotal = totalVal || 1; const pT = (valT / safeTotal) * 100; const pP = (valP / safeTotal) * 100; const pN = (valN / safeTotal) * 100; const pV = (valV / safeTotal) * 100; const endT = pT; const endP = endT + pP; const endN = endP + pN; const cT = '#FEB93D'; const cP = '#29D9A8'; const cN = '#00BAFF'; const cV = '#6078F6'; const conicStyle = ` width: 100%; height: 100%; border-radius: 50%; background: conic-gradient( ${cT} 0% ${endT}%, ${cP} ${endT}% ${endP}%, ${cN} ${endP}% ${endN}%, ${cV} ${endN}% 100% ); -webkit-mask: radial-gradient(closest-side, transparent 75%, black 76%); mask: radial-gradient(closest-side, transparent 75%, black 76%); `; const renderLegendItem = (label, val, color) => { if (!val || val <= 0) return ''; return html` <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 13px;"> <div style="display: flex; align-items: center;"> <span style="width: 8px; height: 8px; border-radius: 50%; background: ${color}; margin-right: 6px;"></span> <span style="opacity: 0.9;">${label}</span> </div> <span style="font-weight: bold;">${val.toFixed(2)} <span style="font-size: 10px; opacity: 0.7;">Â∫¶</span></span> </div> `; }; detailPopupHtml = html` <div class="detail-popup-overlay" @click=${this['\u005F\u0063\u006C\u006F\u0073\u0065\u0044\u0061\u0079\u0044\u0065\u0074\u0061\u0069\u006C']} style="position: absolute; top:0; left:0; right:0; bottom:0; z-index: 101; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px);"> <div class="detail-card" @click=${e => e.stopPropagation()} style="background: #1e293b; padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); width: 85%; max-width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: popIn 0.2s ease-out;"> <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"> <div style="font-size: 16px; font-weight: bold;">üìÖ ${d.dateKey.substr(0, 4)}-${d.dateKey.substr(4, 2)}-${d.dateKey.substr(6, 2)}</div> <div style="background: rgba(255,255,255,0.1); border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer;" @click=${this['\u005F\u0063\u006C\u006F\u0073\u0065\u0044\u0061\u0079\u0044\u0065\u0074\u0061\u0069\u006C']}> <ha-icon icon="mdi:close" style="--mdc-icon-size: 18px; color: rgba(255,255,255,0.9);"></ha-icon> </div> </div> <div class="detail-content"> <!-- ÁéØÂΩ¢Âõæ --> <!-- ÁéØÂΩ¢Âõæ --> <div style="width: 120px; height: 120px; position: relative; margin: 0 auto 16px auto;"> <!-- 1. ÂÆûÈôÖÁöÑÂúÜÁéØ (ËÉåÊôØ+Mask) --> <div style="${conicStyle} position: absolute; top: 0; left: 0;"></div> <!-- 2. ‰∏≠ÂøÉÁöÑÊñáÂ≠ó (ÊµÆÂú®‰∏äÈù¢) --> <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none;"> <span style="font-size: 12px; opacity: 0.7;">ÊÄªÁîµÈáè</span> <span style="font-size: 18px; font-weight: bold; color: #fff;">${totalVal.toFixed(2)}</span> </div> </div> <!-- Âõæ‰æãÂàóË°® --> <div class="legend-list" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;"> ${renderLegendItem('Â∞ñÊÆµ', valT, cT)} ${renderLegendItem('Â≥∞ÊÆµ', valP, cP)} ${renderLegendItem('Âπ≥ÊÆµ', valN, cN)} ${renderLegendItem('Ë∞∑ÊÆµ', valV, cV)} </div> <div style="margin-top: 16px; text-align: center; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);"> <div style="font-size: 12px; opacity: 0.7; margin-bottom: 2px;">È¢Ñ‰º∞ÁîµË¥π</div> <div style="font-size: 20px; font-weight: bold; color: #fbbf24;">¬• ${d.data.cost}</div> </div> </div> </div> </div> <style> @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } } </style> `; } historyHtml = html` <div class="modal-overlay" @click=${this['\u005F\u0074\u006F\u0067\u0067\u006C\u0065\u0048\u0069\u0073\u0074\u006F\u0072\u0079']}> ${detailPopupHtml} <div class="modal-content" @click=${e => e.stopPropagation()}> <div class="modal-header"> <h3>üìÖ ${targetYear}Âπ¥${targetMonth + 1}ÊúàÁî®ÁîµÊó•ÂéÜ</h3> <div style="display: flex; gap: 16px;"> <ha-icon icon="mdi:close" @click=${this['\u005F\u0074\u006F\u0067\u0067\u006C\u0065\u0048\u0069\u0073\u0074\u006F\u0072\u0079']}></ha-icon> </div> </div> <div class="calendar-container"> <div class="calendar-weekdays"> <div>‰∏Ä</div><div>‰∫å</div><div>‰∏â</div><div>Âõõ</div><div>‰∫î</div><div>ÂÖ≠</div><div>Êó•</div> </div> <div class="calendar-grid"> ${emptyCells} ${dayCells} </div> <div class="calendar-footer"> <div class="footer-item"> <span>Êú¨ÊúàÊÄªÁîµÈáè</span> <div class="footer-value">${monthTotalUsage.toFixed(2)} <span class="unit">Â∫¶</span></div> </div> <div class="footer-item"> <span>Êú¨ÊúàÈ¢Ñ‰º∞ÁîµË¥π</span> <div class="footer-value coin">${monthTotalCost.toFixed(2)} <span class="unit">ÂÖÉ</span></div> </div> </div> </div> </div> </div> `; } return html` <ha-card style="position: relative;"> ${historyHtml} <div class="card-content"> <div class="header"> <div class="balance-title"> <ha-icon icon="mdi:flash"></ha-icon> <span>${this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0074\u0069\u0074\u006C\u0065'] || 'ÂõΩÂÆ∂ÁîµÁΩë 95598'}</span> </div> ${updateTime ? html`<div class="header-time">Êõ¥Êñ∞‰∫é ${updateTime}</div>` : ''} </div> <div class="balance-container"> <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px;">ÁîµË¥π‰ΩôÈ¢ù</div> <div class="balance-value"> <span>${balance.toFixed(2)}</span> <span class="unit">ÂÖÉ</span> </div> ${estimatedDaysText ? html`<div style="font-size: 12px; opacity: 0.7; margin-top: 4px;">${estimatedDaysText}</div>` : ''} </div> <div class="data-grid"> <!-- Á¨¨‰∏ÄË°å 1: È¢ÑÂ≠òÈáëÈ¢ù --> <div class="data-item"> <div class="data-label"> <ha-icon icon="mdi:wallet"></ha-icon> <span>È¢ÑÂ≠òÈáëÈ¢ù</span> </div> <div class="data-value"> ${monthlyCost.toFixed(2)} <span class="data-unit">ÂÖÉ</span> </div> </div> <!-- Á¨¨‰∏ÄË°å 2: Êó•Áî®ÁîµÈáè (ÂèØÁÇπÂáª) --> <div class="data-item ${this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0065\u006E\u0061\u0062\u006C\u0065\u005F\u0064\u0061\u0069\u006C\u0079\u005F\u0063\u0061\u006C\u0065\u006E\u0064\u0061\u0072'] !== false ? 'clickable' : ''}" @click=${this['\u0063\u006F\u006E\u0066\u0069\u0067']['\u0065\u006E\u0061\u0062\u006C\u0065\u005F\u0064\u0061\u0069\u006C\u0079\u005F\u0063\u0061\u006C\u0065\u006E\u0064\u0061\u0072'] !== false ? this['\u005F\u0074\u006F\u0067\u0067\u006C\u0065\u0048\u0069\u0073\u0074\u006F\u0072\u0079'] : null}> <div class="data-label"> <ha-icon icon="mdi:calendar-today"></ha-icon> <span>Êó•Áî®ÁîµÈáè</span> </div> <div class="data-value"> ${parseFloat(dailyUsage).toFixed(2)} <span class="data-unit">Â∫¶</span> </div> </div> <!-- Á¨¨‰∏ÄË°å 3: ‰∏äÊúàÁî®Áîµ --> <div class="data-item"> <div class="data-label"> <ha-icon icon="mdi:lightning-bolt"></ha-icon> <span>‰∏äÊúàÁî®Áîµ</span> </div> <div class="data-value"> ${monthlyUsage.toFixed(0)} <span class="data-unit">Â∫¶</span> </div> </div> <!-- Á¨¨‰∫åË°å 1: ‰∏äÊúàÁîµË¥π (estiAmt) --> <div class="data-item"> <div class="data-label"> <ha-icon icon="mdi:cash"></ha-icon> <span>‰∏äÊúàÁîµË¥π</span> </div> <div class="data-value"> ${lastMonthCost.toFixed(2)} <span class="data-unit">ÂÖÉ</span> </div> </div> <!-- Á¨¨‰∫åË°å 2: Âπ¥ÊÄªÁîµÈáè --> <div class="data-item"> <div class="data-label"> <ha-icon icon="mdi:chart-line"></ha-icon> <span>Âπ¥ÊÄªÁîµÈáè</span> </div> <div class="data-value"> ${totalYearPq.toFixed(0)} <span class="data-unit">Â∫¶</span> </div> </div> <!-- Á¨¨‰∫åË°å 3: Âπ¥ÊÄªÁîµË¥π --> <div class="data-item"> <div class="data-label"> <ha-icon icon="mdi:currency-cny"></ha-icon> <span>Âπ¥ÊÄªÁîµË¥π</span> </div> <div class="data-value"> ${totalYearCost.toFixed(2)} <span class="data-unit">ÂÖÉ</span> </div> </div> </div> <div class="tier-section"> <div class="tier-header"> <div class="tier-label">üìä ÂΩìÂâçÈò∂Ê¢Ø: ${tierLevel}</div> <div class="tier-price">Âçï‰ª∑: ¬•${currentPrice.toFixed(2)}/Â∫¶</div> </div> <div class="progress-section"> <div class="progress-title"> <span>Âπ¥Â∫¶Áî®ÁîµËøõÂ∫¶</span> <span style="font-size: 12px; opacity: 0.8">${yearlyUsage.toFixed(0)} Â∫¶</span> </div> <!-- ÁªÑÂêàËøõÂ∫¶Êù°ÂÆπÂô® --> <div class="combined-progress"> <!-- ‰∏ÄÊ°£ --> <div class="progress-segment segment-1"> <div class="segment-fill tier1" style="width: ${tier1Percent}%"></div> <div class="segment-marker">${tier1Max}</div> </div> <!-- ‰∫åÊ°£ --> <div class="progress-segment segment-2"> <div class="segment-fill tier2" style="width: ${tier2Percent}%"></div> <div class="segment-marker">${tier2Max}</div> </div> <!-- ‰∏âÊ°£ --> <div class="progress-segment segment-3"> <div class="segment-fill tier3" style="width: ${Math.min(tier3Usage / (tier2Max - tier1Max) * 100, 100)}%"></div> </div> </div> <div class="progress-legend"> <span class="legend-item"><span class="dot tier1"></span>‰∏ÄÊ°£</span> <span class="legend-item"><span class="dot tier2"></span>‰∫åÊ°£</span> <span class="legend-item"><span class="dot tier3"></span>‰∏âÊ°£</span> </div> </div> </div> ${payHistoryHtml} ${fullPayHistoryHtml} </div> </ha-card> `; } static get styles() { return css` ha-card { padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); } .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; } .balance-title { font-size: 18px; font-weight: bold; display: flex; align-items: center; opacity: 0.95; } .balance-title ha-icon { margin-right: 8px; --mdc-icon-size: 24px; } .header-time { font-size: 12px; opacity: 0.7; } .balance-container { text-align: center; margin-bottom: 30px; margin-top: 10px; } .balance-value { font-size: 42px; font-weight: bold; line-height: 1; } .balance-value.unit { font-size: 16px; font-weight: normal; margin-left: 4px; opacity: 0.8; } .data-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 24px; } @media(max-width: 320px) { .data-grid { grid-template-columns: repeat(2, 1fr); } } .data-item { background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 10px; backdrop-filter: blur(10px); } .clickable { cursor: pointer; transition: background 0.2s; } .clickable:hover { background: rgba(255, 255, 255, 0.25); } .data-label { font-size: 12px; opacity: 0.9; margin-bottom: 4px; display: flex; align-items: center; white-space: nowrap; } .data-label ha-icon { margin-right: 4px; --mdc-icon-size: 16px; } .data-value { font-size: 18px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .data-value.data-unit { font-size: 12px; opacity: 0.8; margin-left: 2px; vertical-align: baseline; } .tier-section { background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 16px; backdrop-filter: blur(10px); } .tier-header { display: flex; justify-content: space-between; margin-bottom: 12px; } .tier-label { font-size: 14px; font-weight: bold; } .tier-price { font-size: 14px; opacity: 0.9; } .progress-section { margin-top: 16px; } .progress-title { font-size: 14px; margin-bottom: 8px; opacity: 0.9; display: flex; justify-content: space-between; align-items: center; } .combined-progress { display: flex; height: 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px; overflow: hidden; margin-bottom: 8px; } .progress-segment { position: relative; height: 100%; border-right: 1px solid rgba(255, 255, 255, 0.3); } .progress-segment:last-child { border-right: none; } .segment-1 { flex: 2; } .segment-2 { flex: 1; } .segment-3 { flex: 1; } .segment-fill { height: 100%; transition: width 0.3s ease; } .segment-fill.tier1 { background: #4ade80; } .segment-fill.tier2 { background: #fbbf24; } .segment-fill.tier3 { background: #f87171; } .segment-marker { position: absolute; right: 2px; top: 14px; font-size: 10px; opacity: 0.6; transform: translateX(50%); } .progress-legend { display: flex; justify-content: flex-start; gap: 12px; font-size: 11px; opacity: 0.8; margin-top: 4px; } .legend-item { display: flex; align-items: center; } .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; } .dot.tier1 { background: #4ade80; } .dot.tier2 { background: #fbbf24; } .dot.tier3 { background: #f87171; } .pay-section { background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px; margin-top: 16px; backdrop-filter: blur(10px); } .pay-title { font-size: 14px; opacity: 0.9; margin-bottom: 8px; display: flex; align-items: center; } .pay-list { display: flex; flex-direction: column; gap: 8px; } .pay-item { display: flex; justify-content: space-between; font-size: 13px; align-items: center; } .pay-date { opacity: 0.8; } .pay-amt { font-weight: bold; } .deadline-section { background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 12px; backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; } .deadline-label { font-size: 12px; opacity: 0.9; display: flex; align-items: center; } .deadline-label ha-icon { margin-right: 4px; --mdc-icon-size: 16px; } .deadline-value { font-size: 13px; font-weight: bold; } .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 99; display: flex; justify-content: center; align-items: center; border-radius: 12px; } .modal-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 95%; max-height: 95%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); } .modal-header { padding: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; } .modal-header h3 { margin: 0; font-size: 16px; } .calendar-container { padding: 12px; overflow-y: auto; } .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; opacity: 0.6; font-size: 13px; margin-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 4px; } .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; } .calendar-cell { aspect-ratio: 1; background: rgba(255, 255, 255, 0.05); border-radius: 6px; display: flex; flex-direction: column; align-items: center; font-size: 12px; position: relative; min-height: 50px; } .calendar-cell.has-data { background: rgba(255, 255, 255, 0.1); } .calendar-cell.empty { background: transparent !important; border: none !important; pointer-events: none; } .calendar-cell.low { border: 1px solid rgba(74, 222, 128, 0.3); } .calendar-cell.medium { border: 1px solid rgba(251, 191, 36, 0.3); } .calendar-cell.high { border: 1px solid rgba(248, 113, 113, 0.3); } .calendar-cell.no-data { opacity: 0.3; } .cell-date { opacity: 0.6; font-size: 11px; position: absolute; top: 2px; left: 3px; } .cell-content { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 14px; width: 100%; } .cell-usage { font-weight: bold; font-size: 12px; line-height: 1.1; white-space: nowrap; } .cell-usage .unit { font-size: 10px; font-weight: normal; margin-left: 0; opacity: 0.9; vertical-align: top; } .cell-cost { font-size: 9px; opacity: 0.7; } .calendar-footer { margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-around; align-items: center; } .footer-item { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 12px; opacity: 0.9; } .footer-value { font-size: 16px; font-weight: bold; } .footer-value .unit { font-size: 12px; font-weight: normal; } .footer-value.coin { color: #fbbf24; } .clickable { cursor: pointer; transition: background 0.2s; position: relative; } .clickable:active { background: rgba(255, 255, 255, 0.25); } .clickable::after { content: 'üîé'; position: absolute; top: 6px; right: 6px; font-size: 10px; opacity: 0.5; }`; } } customElements.define('sgcc-electricity-card', SgccElectricityCard); window.customCards = window.customCards || []; window.customCards.push({ type: 'sgcc-electricity-card', name: 'Shaobor ÁîµË¥πÂç°Áâá', description: 'Shaobor ÁîµË¥πÊü•ËØ¢Âç°Áâá', preview: true, }); console.info( '%c SHAOBOR-ELECTRICITY-CARD %c v2.0.0 (LitElement) ', 'color: white; background: #667eea; font-weight: bold;', 'color: #667eea; background: white; font-weight: bold;' ); 